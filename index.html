<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SKATE Score ‚Äî Digital Game of SKATE Scorekeeper</title>
<meta name="description" content="Free digital scorekeeper for Game of SKATE. Track players, letters, rounds, and match history ‚Äî all in your browser.">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõπ</text></svg>">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#f59e0b">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0a0a;--card:#161616;--accent:#f59e0b;--accent2:#ef4444;--text:#e5e5e5;--muted:#737373;--green:#22c55e;--radius:12px}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding:16px;max-width:480px;margin:0 auto}
h1{font-size:1.6rem;text-align:center;margin:12px 0 4px}
.subtitle{text-align:center;color:var(--muted);font-size:.85rem;margin-bottom:20px}
.card{background:var(--card);border-radius:var(--radius);padding:16px;margin-bottom:12px}
button{background:var(--accent);color:#000;border:none;border-radius:8px;padding:10px 20px;font-size:.95rem;font-weight:600;cursor:pointer;transition:opacity .2s}
button:hover{opacity:.85}
button:active{transform:scale(.97)}
button.danger{background:var(--accent2);color:#fff}
button.ghost{background:transparent;color:var(--accent);border:1px solid var(--accent);padding:8px 16px;font-size:.85rem}
button.sm{padding:6px 12px;font-size:.8rem}
input{background:#222;border:1px solid #333;color:var(--text);border-radius:8px;padding:10px 12px;font-size:.95rem;width:100%}
input:focus{outline:none;border-color:var(--accent)}
.letters{display:flex;gap:6px;justify-content:center;margin:8px 0}
.letter{width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:8px;font-weight:700;font-size:1.1rem;background:#222;color:#555;transition:all .3s}
.letter.active{background:var(--accent2);color:#fff}
.player-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid #222}
.player-row:last-child{border-bottom:none}
.player-name{font-weight:600;font-size:1rem;flex:1}
.player-actions{display:flex;gap:6px;align-items:center}
.status-badge{font-size:.75rem;padding:3px 8px;border-radius:20px;font-weight:600}
.status-badge.out{background:var(--accent2);color:#fff}
.status-badge.alive{background:var(--green);color:#000}
.setup-players{display:flex;flex-direction:column;gap:8px;margin:12px 0}
.player-input-row{display:flex;gap:8px}
.player-input-row input{flex:1}
.player-input-row button{flex-shrink:0}
.round-info{text-align:center;color:var(--accent);font-weight:600;margin-bottom:12px;font-size:.9rem}
.history-item{padding:10px 0;border-bottom:1px solid #222;font-size:.85rem}
.history-item:last-child{border-bottom:none}
.history-date{color:var(--muted);font-size:.75rem}
.winner-banner{text-align:center;padding:20px;font-size:1.3rem;font-weight:700;color:var(--green)}
.tab-bar{display:flex;gap:0;margin-bottom:16px;border-radius:var(--radius);overflow:hidden;background:var(--card)}
.tab{flex:1;padding:10px;text-align:center;font-size:.85rem;font-weight:600;cursor:pointer;color:var(--muted);transition:all .2s}
.tab.active{background:var(--accent);color:#000}
.flex-center{display:flex;gap:8px;justify-content:center;margin-top:12px}
.empty{text-align:center;color:var(--muted);padding:30px;font-size:.9rem}
.bracket{overflow-x:auto;padding:16px 0}
.bracket-round{display:inline-flex;flex-direction:column;justify-content:center;vertical-align:top;min-width:160px;margin-right:8px}
.bracket-round-title{text-align:center;font-size:.75rem;color:var(--accent);font-weight:700;margin-bottom:8px;text-transform:uppercase}
.bracket-match{background:var(--card);border-radius:8px;margin-bottom:12px;overflow:hidden;border:1px solid #222}
.bracket-slot{padding:8px 10px;font-size:.85rem;display:flex;justify-content:space-between;align-items:center;cursor:pointer;transition:background .15s}
.bracket-slot:first-child{border-bottom:1px solid #222}
.bracket-slot:hover{background:#1e1e1e}
.bracket-slot.winner{color:var(--green);font-weight:700}
.bracket-slot.loser{color:var(--muted);text-decoration:line-through}
.bracket-slot .seed{color:var(--muted);font-size:.7rem;margin-right:6px}
.bracket-connector{width:8px;display:inline-flex;flex-direction:column;justify-content:center;vertical-align:top}
.tourney-status{text-align:center;font-size:.85rem;color:var(--muted);margin:8px 0}
.tourney-champion{text-align:center;font-size:1.4rem;font-weight:800;color:var(--green);padding:16px}
</style>
</head>
<body>

<h1>üõπ SKATE Score</h1>
<p class="subtitle">Digital Game of SKATE Scorekeeper</p>

<div class="tab-bar">
  <div class="tab active" data-tab="game" onclick="switchTab('game')">Game</div>
  <div class="tab" data-tab="history" onclick="switchTab('history')">History</div>
  <div class="tab" data-tab="stats" onclick="switchTab('stats')">Stats</div>
  <div class="tab" data-tab="tournament" onclick="switchTab('tournament')">üèÜ</div>
</div>

<div id="game-tab"></div>
<div id="history-tab" style="display:none"></div>
<div id="stats-tab" style="display:none"></div>
<div id="tournament-tab" style="display:none"></div>

<script>
// --- HTML Escaping Utility ---
function escapeHtml(str) {
  if (typeof str !== 'string') return str;
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

// --- Sound Effects (Web Audio API, no external files) ---
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let audioCtx;
function ensureAudio() { if (!audioCtx) audioCtx = new AudioCtx(); return audioCtx; }

function playLetterSound() {
  const ctx = ensureAudio();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.connect(gain); gain.connect(ctx.destination);
  osc.type = 'triangle';
  osc.frequency.setValueAtTime(220, ctx.currentTime);
  osc.frequency.linearRampToValueAtTime(110, ctx.currentTime + 0.25);
  gain.gain.setValueAtTime(0.35, ctx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3);
  osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.3);
}

function playGameOverSound() {
  const ctx = ensureAudio();
  [0, 0.15, 0.3].forEach((t, i) => {
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain); gain.connect(ctx.destination);
    osc.type = 'square';
    osc.frequency.setValueAtTime([200, 160, 120][i], ctx.currentTime + t);
    gain.gain.setValueAtTime(0.25, ctx.currentTime + t);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + t + 0.18);
    osc.start(ctx.currentTime + t); osc.stop(ctx.currentTime + t + 0.2);
  });
}

function playWinSound() {
  const ctx = ensureAudio();
  [0, 0.12, 0.24, 0.36].forEach((t, i) => {
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain); gain.connect(ctx.destination);
    osc.type = 'sine';
    osc.frequency.setValueAtTime([523, 659, 784, 1047][i], ctx.currentTime + t);
    gain.gain.setValueAtTime(0.3, ctx.currentTime + t);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + t + 0.15);
    osc.start(ctx.currentTime + t); osc.stop(ctx.currentTime + t + 0.18);
  });
}

// --- Share / Export Game Results ---
function generateShareCanvas(data) {
  // data: { winner, players: [{name, letters}], rounds, date, tricks }
  const W = 600, rowH = 44, pad = 24;
  const headerH = 130, trickH = data.tricks && data.tricks.length ? 36 : 0;
  const H = headerH + data.players.length * rowH + trickH + pad * 2 + 40;
  const c = document.createElement('canvas');
  c.width = W; c.height = H;
  const ctx = c.getContext('2d');

  // Background
  ctx.fillStyle = '#0a0a0a'; ctx.fillRect(0, 0, W, H);
  ctx.fillStyle = '#161616';
  const rx = 16, ry = 16;
  const bx = pad, by = pad, bw = W - pad * 2, bh = H - pad * 2;
  ctx.beginPath();
  ctx.moveTo(bx + rx, by);
  ctx.lineTo(bx + bw - rx, by); ctx.quadraticCurveTo(bx + bw, by, bx + bw, by + ry);
  ctx.lineTo(bx + bw, by + bh - ry); ctx.quadraticCurveTo(bx + bw, by + bh, bx + bw - rx, by + bh);
  ctx.lineTo(bx + rx, by + bh); ctx.quadraticCurveTo(bx, by + bh, bx, by + bh - ry);
  ctx.lineTo(bx, by + ry); ctx.quadraticCurveTo(bx, by, bx + rx, by);
  ctx.closePath(); ctx.fill();

  let y = pad + 28;

  // Title
  ctx.fillStyle = '#f59e0b';
  ctx.font = 'bold 26px -apple-system, BlinkMacSystemFont, sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText('üõπ SKATE Score', W / 2, y); y += 34;

  // Winner
  ctx.fillStyle = '#22c55e';
  ctx.font = 'bold 22px -apple-system, BlinkMacSystemFont, sans-serif';
  ctx.fillText('üèÜ ' + data.winner + ' Wins!', W / 2, y); y += 24;

  // Meta
  ctx.fillStyle = '#737373';
  ctx.font = '14px -apple-system, BlinkMacSystemFont, sans-serif';
  const meta = data.rounds + (data.rounds === 1 ? ' round' : ' rounds') + ' ‚Ä¢ ' + data.players.length + ' players' + (data.date ? ' ‚Ä¢ ' + new Date(data.date).toLocaleDateString() : '');
  ctx.fillText(meta, W / 2, y); y += 28;

  // Players
  ctx.textAlign = 'left';
  const WORD = 'SKATE';
  data.players.forEach(p => {
    ctx.fillStyle = '#e5e5e5';
    ctx.font = '600 16px -apple-system, BlinkMacSystemFont, sans-serif';
    ctx.fillText(p.name, pad + 20, y);
    // Letters on the right
    const letterStartX = W - pad - 20 - 5 * 30;
    WORD.split('').forEach((l, i) => {
      const lx = letterStartX + i * 30, ly = y - 14;
      ctx.fillStyle = i < p.letters ? '#ef4444' : '#222';
      ctx.beginPath();
      ctx.roundRect ? ctx.roundRect(lx, ly, 26, 26, 6) : ctx.rect(lx, ly, 26, 26);
      ctx.fill();
      ctx.fillStyle = i < p.letters ? '#fff' : '#555';
      ctx.font = 'bold 14px -apple-system, BlinkMacSystemFont, sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText(l, lx + 13, ly + 18);
      ctx.textAlign = 'left';
    });
    y += rowH;
  });

  // Tricks
  if (data.tricks && data.tricks.length) {
    y += 8;
    ctx.fillStyle = '#f59e0b';
    ctx.font = 'bold 12px -apple-system, BlinkMacSystemFont, sans-serif';
    ctx.textAlign = 'center';
    const trickStr = data.tricks.map(t => t.name).filter(Boolean).join(' ‚Üí ');
    if (trickStr) ctx.fillText('Tricks: ' + (trickStr.length > 60 ? trickStr.slice(0, 57) + '‚Ä¶' : trickStr), W / 2, y);
  }

  // Footer
  ctx.fillStyle = '#333';
  ctx.font = '11px -apple-system, BlinkMacSystemFont, sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText('clawdiard.github.io/skate-score', W / 2, H - pad + 4);

  return c;
}

async function shareResults(data) {
  const canvas = generateShareCanvas(data);
  try {
    const blob = await new Promise(r => canvas.toBlob(r, 'image/png'));
    const file = new File([blob], 'skate-score.png', { type: 'image/png' });
    if (navigator.canShare && navigator.canShare({ files: [file] })) {
      await navigator.share({
        text: 'üõπ ' + data.winner + ' wins at SKATE! ' + data.rounds + (data.rounds === 1 ? ' round' : ' rounds'),
        files: [file]
      });
      return;
    }
  } catch (e) { if (e.name === 'AbortError') return; }
  // Fallback: download
  const link = document.createElement('a');
  link.download = 'skate-score-' + Date.now() + '.png';
  link.href = canvas.toDataURL('image/png');
  link.click();
}

function shareCurrentGame() {
  if (!state) return;
  const alive = state.players.filter(p => p.letters < 5);
  const winner = alive[0] || state.players[0];
  shareResults({ winner: winner.name, players: state.players, rounds: state.round, date: new Date().toISOString(), tricks: state.tricks || [] });
}

function shareFromHistory(idx) {
  const h = history[idx];
  if (!h) return;
  shareResults({ winner: h.winner, players: h.players, rounds: h.rounds, date: h.date, tricks: h.tricks || [] });
}

function copyResultsText(data) {
  const lines = ['üõπ SKATE Score Results', 'üèÜ ' + data.winner + ' Wins!', data.rounds + (data.rounds === 1 ? ' round' : ' rounds') + ' ‚Ä¢ ' + data.players.length + ' players', ''];
  data.players.forEach(p => {
    const letters = 'SKATE'.slice(0, p.letters) || '‚Äî';
    lines.push(p.name + ': ' + (p.letters >= 5 ? 'SKATE (out)' : letters));
  });
  if (data.tricks && data.tricks.length) {
    const ts = data.tricks.map(t => t.name).filter(Boolean).join(' ‚Üí ');
    if (ts) lines.push('', 'Tricks: ' + ts);
  }
  lines.push('', 'clawdiard.github.io/skate-score');
  navigator.clipboard.writeText(lines.join('\n')).then(() => {
    const btn = event.target;
    const orig = btn.textContent;
    btn.textContent = 'Copied!';
    setTimeout(() => btn.textContent = orig, 1500);
  });
}

function playUndoSound() {
  const ctx = ensureAudio();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.connect(gain); gain.connect(ctx.destination);
  osc.type = 'sine';
  osc.frequency.setValueAtTime(330, ctx.currentTime);
  osc.frequency.linearRampToValueAtTime(440, ctx.currentTime + 0.12);
  gain.gain.setValueAtTime(0.25, ctx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.15);
  osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.15);
}

// --- Haptics (Vibration API) ---
function vibrateShort() { if (navigator.vibrate) navigator.vibrate(50); }
function vibrateLong()  { if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 200]); }

const WORD = 'SKATE';
let state = JSON.parse(localStorage.getItem('skate-state') || 'null');
let history = JSON.parse(localStorage.getItem('skate-history') || '[]');

function save() {
  localStorage.setItem('skate-state', JSON.stringify(state));
  localStorage.setItem('skate-history', JSON.stringify(history));
}

function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
  ['game','history','stats','tournament'].forEach(t => {
    document.getElementById(t+'-tab').style.display = t === tab ? 'block' : 'none';
  });
  if (tab === 'game') renderGame();
  if (tab === 'history') renderHistory();
  if (tab === 'stats') renderStats();
  if (tab === 'tournament') renderTournament();
}

function renderLetters(count) {
  return WORD.split('').map((l, i) =>
    `<div class="letter ${i < count ? 'active' : ''}">${l}</div>`
  ).join('');
}

function shareTournament() {
  if (!tournament) return;
  const finalMatch = tournament.bracket[tournament.bracket.length - 1][0];
  if (!finalMatch.winner) return;
  // Build pseudo player list from bracket results
  const players = tournament.players.map(n => ({ name: n, letters: n === finalMatch.winner ? 0 : 5 }));
  shareResults({ winner: finalMatch.winner, players, rounds: tournament.bracket.length, date: tournament.date, tricks: [] });
}

function renderGame() {
  const el = document.getElementById('game-tab');
  if (!state) {
    el.innerHTML = `
      <div class="card">
        <h3 style="margin-bottom:12px">New Game</h3>
        <div class="setup-players" id="player-inputs">
          <div class="player-input-row"><input placeholder="Player 1" value="Player 1"><button class="danger sm" onclick="removePlayerInput(this)" style="display:none">‚úï</button></div>
          <div class="player-input-row"><input placeholder="Player 2" value="Player 2"><button class="danger sm" onclick="removePlayerInput(this)" style="display:none">‚úï</button></div>
        </div>
        <div class="flex-center">
          <button class="ghost" onclick="addPlayerInput()">+ Add Player</button>
        </div>
        <div class="flex-center" style="margin-top:16px">
          <button onclick="startGame()">Start Game üõπ</button>
        </div>
      </div>
      <div class="card">
        <h3 style="margin-bottom:8px">How to Play</h3>
        <p style="font-size:.85rem;color:var(--muted);line-height:1.5">
          One player sets a trick. Others must land it. Fail = get a letter (S-K-A-T-E). 
          Spell SKATE and you're out. Last one standing wins!
        </p>
      </div>`;
    updateRemoveButtons();
    return;
  }

  const alive = state.players.filter(p => p.letters < 5);
  if (alive.length <= 1) {
    const winner = alive[0] || state.players[0];
    el.innerHTML = `
      <div class="card">
        <div class="winner-banner">üèÜ ${escapeHtml(winner.name)} Wins!</div>
        <div style="text-align:center;color:var(--muted);font-size:.85rem;margin-bottom:12px">
          Round ${state.round} ‚Ä¢ ${state.players.length} players
        </div>
        ${state.players.map(p => `
          <div class="player-row">
            <span class="player-name">${escapeHtml(p.name)}</span>
            <div class="letters">${renderLetters(p.letters)}</div>
          </div>`).join('')}
        <div class="flex-center" style="margin-top:16px">
          <button onclick="shareCurrentGame()">üì§ Share</button>
          <button class="ghost" onclick="copyResultsText({winner:escapeHtml(winner.name),players:state.players,rounds:state.round,tricks:state.tricks||[]})">üìã Copy</button>
          <button onclick="endGame()">New Game</button>
        </div>
      </div>`;
    if (!state.saved) {
      history.unshift({ date: new Date().toISOString(), players: state.players.map(p=>({...p})), rounds: state.round, winner: winner.name, tricks: (state.tricks||[]).filter(t=>t.name) });
      state.saved = true;
      save();
    }
    return;
  }

  const setter = alive[state.currentSetter % alive.length];
  const currentTrick = (state.tricks || []).find(t => t.round === state.round);
  el.innerHTML = `
    <div class="round-info">Round ${state.round} ‚Äî ${escapeHtml(setter.name)} sets the trick</div>
    <div class="card" style="margin-bottom:12px">
      <div style="display:flex;gap:8px;align-items:center">
        <input id="trick-input" placeholder="Trick name (e.g. Kickflip)" value="${currentTrick ? currentTrick.name : ''}" style="flex:1" oninput="logTrick(this.value)">
      </div>
      ${(state.tricks||[]).length > 0 ? `<div style="margin-top:8px;font-size:.75rem;color:var(--muted)">Recent: ${(state.tricks||[]).slice(-3).map(t=>'R'+t.round+' '+escapeHtml(t.name)).join(' ‚Üí ')}</div>` : ''}
    </div>
    ${state.players.map((p, i) => {
      const isOut = p.letters >= 5;
      return `
      <div class="card" style="${isOut ? 'opacity:.4' : ''}">
        <div class="player-row" style="border:none">
          <div>
            <div class="player-name">${escapeHtml(p.name)}</div>
            <div class="letters" style="justify-content:flex-start;margin-top:4px">${renderLetters(p.letters)}</div>
          </div>
          <div class="player-actions">
            ${isOut ? '<span class="status-badge out">OUT</span>' :
              `<button class="danger sm" onclick="giveLetter(${i})">+ Letter</button>
               <button class="sm ghost" onclick="undoLetter(${i})" ${p.letters===0?'disabled style="opacity:.3"':''}>Undo</button>`
            }
          </div>
        </div>
      </div>`;
    }).join('')}
    <div class="flex-center">
      <button class="ghost" onclick="nextRound()">Next Round ‚Üí</button>
      <button class="danger sm" id="end-game-btn" onclick="confirmEndGame(this)">End Game</button>
    </div>`;
}

function addPlayerInput() {
  const container = document.getElementById('player-inputs');
  const n = container.children.length + 1;
  const row = document.createElement('div');
  row.className = 'player-input-row';
  row.innerHTML = `<input placeholder="Player ${n}" value="Player ${n}"><button class="danger sm" onclick="removePlayerInput(this)">‚úï</button>`;
  container.appendChild(row);
  updateRemoveButtons();
}

function removePlayerInput(btn) {
  btn.parentElement.remove();
  updateRemoveButtons();
}

function updateRemoveButtons() {
  const rows = document.querySelectorAll('#player-inputs .player-input-row');
  rows.forEach(r => {
    r.querySelector('button').style.display = rows.length > 2 ? '' : 'none';
  });
}

function startGame() {
  const inputs = document.querySelectorAll('#player-inputs input');
  const names = [...inputs].map(i => i.value.trim()).filter(Boolean);
  if (names.length < 2) return alert('Need at least 2 players');
  state = { players: names.map(n => ({ name: n, letters: 0 })), round: 1, currentSetter: 0, saved: false, tricks: [] };
  save(); renderGame();
}

function logTrick(name) {
  if (!state || !state.tricks) state.tricks = [];
  const existing = state.tricks.find(t => t.round === state.round);
  const setter = state.players.filter(p => p.letters < 5)[state.currentSetter % state.players.filter(p => p.letters < 5).length];
  if (existing) { existing.name = name; existing.setter = setter.name; }
  else state.tricks.push({ round: state.round, name: name, setter: setter.name });
  save();
}

function giveLetter(idx) {
  if (state.players[idx].letters < 5) {
    state.players[idx].letters++;
    const isOut = state.players[idx].letters >= 5;
    const alive = state.players.filter(p => p.letters < 5);
    if (alive.length <= 1) {
      playWinSound(); vibrateLong();
    } else if (isOut) {
      playGameOverSound(); vibrateLong();
    } else {
      playLetterSound(); vibrateShort();
    }
    save(); renderGame();
  }
}

function undoLetter(idx) {
  if (state.players[idx].letters > 0) {
    state.players[idx].letters--;
    playUndoSound();
    save(); renderGame();
  }
}

function nextRound() {
  state.round++;
  state.currentSetter++;
  save(); renderGame();
}

let _endConfirmTimer = null;
function confirmEndGame(btn) {
  if (btn.dataset.confirming === 'true') {
    clearTimeout(_endConfirmTimer);
    btn.dataset.confirming = 'false';
    endGame();
    return;
  }
  btn.dataset.confirming = 'true';
  btn.textContent = 'Tap again to confirm';
  _endConfirmTimer = setTimeout(() => {
    btn.dataset.confirming = 'false';
    btn.textContent = 'End Game';
  }, 3000);
}

function endGame() {
  if (state && state.players && state.players.length) {
    const sorted = [...state.players].sort((a, b) => a.letters - b.letters);
    const winner = sorted[0];
    if (!state.saved) {
      history.unshift({
        date: new Date().toISOString(),
        players: state.players.map(p => ({...p})),
        rounds: state.round || 1,
        winner: winner.name,
        tricks: (state.tricks || []).filter(t => t.name)
      });
      save();
    }
  }
  state = null;
  save(); renderGame();
}

function renderHistory() {
  const el = document.getElementById('history-tab');
  if (!history.length) { el.innerHTML = '<div class="empty">No games played yet</div>'; return; }
  el.innerHTML = history.map((h, idx) => `
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>üèÜ ${escapeHtml(h.winner)}</strong>
        <span class="history-date">${new Date(h.date).toLocaleDateString()}</span>
      </div>
      <div style="font-size:.85rem;color:var(--muted)">${h.rounds} ${h.rounds === 1 ? 'round' : 'rounds'} ‚Ä¢ ${h.players.length} players</div>
      ${(h.tricks||[]).length ? `<div style="margin:8px 0;font-size:.8rem"><strong style="color:var(--accent)">Tricks:</strong> ${h.tricks.map(t=>`<span style="color:var(--muted)">${escapeHtml(t.name)}${t.setter?' ('+escapeHtml(t.setter)+')':''}</span>`).join(' ‚Üí ')}</div>` : ''}
      ${h.players.map(p => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:4px 0;font-size:.85rem">
          <span>${escapeHtml(p.name)}</span>
          <div class="letters">${renderLetters(p.letters)}</div>
        </div>`).join('')}
      <div class="flex-center" style="margin-top:8px">
        <button class="sm" onclick="shareFromHistory(${idx})">üì§ Share</button>
        <button class="ghost sm" onclick="copyResultsText(history[${idx}])">üìã Copy</button>
      </div>
    </div>`).join('');
}

function renderStats() {
  const el = document.getElementById('stats-tab');
  if (!history.length) { el.innerHTML = '<div class="empty">Play some games to see stats</div>'; return; }
  const players = {};
  history.forEach(h => {
    h.players.forEach(p => {
      if (!players[p.name]) players[p.name] = { wins: 0, games: 0, totalLetters: 0 };
      players[p.name].games++;
      players[p.name].totalLetters += p.letters;
      if (p.name === h.winner) players[p.name].wins++;
    });
  });
  const sorted = Object.entries(players).sort((a,b) => b[1].wins - a[1].wins);
  el.innerHTML = `
    <div class="card">
      <h3 style="margin-bottom:12px">Player Stats</h3>
      ${sorted.map(([name, s]) => `
        <div class="player-row">
          <div>
            <div class="player-name">${escapeHtml(name)}</div>
            <div style="font-size:.8rem;color:var(--muted)">${s.games} ${s.games === 1 ? "game" : "games"} ‚Ä¢ ${(s.totalLetters/s.games).toFixed(1)} avg letters</div>
          </div>
          <div style="text-align:right">
            <div style="font-size:1.1rem;font-weight:700;color:var(--green)">${s.wins}W</div>
            <div style="font-size:.75rem;color:var(--muted)">${Math.round(s.wins/s.games*100)}% win rate</div>
          </div>
        </div>`).join('')}
    </div>
    <div class="card">
      <h3 style="margin-bottom:8px">Overview</h3>
      <div style="font-size:.9rem;color:var(--muted)">
        Total games: ${history.length}<br>
        Total rounds: ${history.reduce((a,h)=>a+h.rounds,0)}<br>
        Unique players: ${sorted.length}
      </div>
    </div>`;
}

// --- Tournament Bracket Mode ---
let tournament = JSON.parse(localStorage.getItem('skate-tournament') || 'null');
function saveTourney() { localStorage.setItem('skate-tournament', JSON.stringify(tournament)); }

function createBracket(names) {
  let size = 1;
  while (size < names.length) size *= 2;
  const seeded = names.map((n, i) => ({ name: n, seed: i + 1 }));
  while (seeded.length < size) seeded.push(null);
  const rounds = Math.log2(size);
  const bracket = [];
  function seedOrder(n) {
    if (n === 1) return [0];
    const prev = seedOrder(n / 2);
    return prev.reduce((a, v) => [...a, v, n - 1 - v], []);
  }
  const order = seedOrder(size);
  const firstRound = [];
  for (let i = 0; i < size; i += 2) {
    firstRound.push({ p1: seeded[order[i]] || null, p2: seeded[order[i + 1]] || null, winner: null });
  }
  firstRound.forEach(m => {
    if (m.p1 && !m.p2) m.winner = m.p1.name;
    else if (!m.p1 && m.p2) m.winner = m.p2.name;
  });
  bracket.push(firstRound);
  for (let r = 1; r < rounds; r++) {
    const prev = bracket[r - 1];
    const round = [];
    for (let i = 0; i < prev.length; i += 2) round.push({ p1: null, p2: null, winner: null });
    bracket.push(round);
  }
  propagateBracket(bracket);
  return bracket;
}

function propagateBracket(bracket) {
  for (let r = 0; r < bracket.length - 1; r++) {
    for (let m = 0; m < bracket[r].length; m += 2) {
      const next = bracket[r + 1][Math.floor(m / 2)];
      const m1 = bracket[r][m], m2 = bracket[r][m + 1];
      if (m1 && m1.winner) next.p1 = { name: m1.winner, seed: (m1.p1 && m1.p1.name === m1.winner) ? m1.p1.seed : (m1.p2 ? m1.p2.seed : null) };
      if (m2 && m2.winner) next.p2 = { name: m2.winner, seed: (m2.p1 && m2.p1.name === m2.winner) ? m2.p1.seed : (m2.p2 ? m2.p2.seed : null) };
      if (next.p1 && !next.p2 && m2 && m2.winner !== null) next.winner = next.p1.name;
      else if (!next.p1 && next.p2 && m1 && m1.winner !== null) next.winner = next.p2.name;
    }
  }
}

function setMatchWinner(ri, mi, name) {
  tournament.bracket[ri][mi].winner = name;
  propagateBracket(tournament.bracket);
  const finalMatch = tournament.bracket[tournament.bracket.length - 1][0];
  if (finalMatch.winner) { playWinSound(); vibrateLong(); }
  else { playLetterSound(); vibrateShort(); }
  saveTourney(); renderTournament();
}

function getRoundName(ri, total) {
  const rem = total - ri;
  if (rem === 1) return 'Final';
  if (rem === 2) return 'Semis';
  if (rem === 3) return 'Quarters';
  return 'Round ' + (ri + 1);
}

function renderTournament() {
  const el = document.getElementById('tournament-tab');
  if (!tournament) {
    el.innerHTML = `
      <div class="card">
        <h3 style="margin-bottom:12px">üèÜ New Tournament</h3>
        <p style="font-size:.85rem;color:var(--muted);margin-bottom:12px">Single-elimination bracket. 3‚Äì16 players.</p>
        <div class="setup-players" id="tourney-inputs">
          <div class="player-input-row"><input placeholder="Player 1" value="Player 1"><button class="danger sm" onclick="removeTourneyInput(this)" style="display:none">‚úï</button></div>
          <div class="player-input-row"><input placeholder="Player 2" value="Player 2"><button class="danger sm" onclick="removeTourneyInput(this)" style="display:none">‚úï</button></div>
          <div class="player-input-row"><input placeholder="Player 3" value="Player 3"><button class="danger sm" onclick="removeTourneyInput(this)" style="display:none">‚úï</button></div>
        </div>
        <div class="flex-center">
          <button class="ghost" onclick="addTourneyInput()">+ Add Player</button>
        </div>
        <div style="margin-top:12px">
          <label style="font-size:.85rem;color:var(--muted)"><input type="checkbox" id="tourney-shuffle"> Randomize seeding</label>
        </div>
        <div class="flex-center" style="margin-top:16px">
          <button onclick="startTournament()">Start Tournament üèÜ</button>
        </div>
      </div>`;
    updateTourneyBtns();
    return;
  }
  const finalMatch = tournament.bracket[tournament.bracket.length - 1][0];
  const champ = finalMatch.winner;
  let html = '';
  if (champ) {
    html += `<div class="card"><div class="tourney-champion">üèÜ ${escapeHtml(champ)} wins the tournament!</div>
      <div class="tourney-status">${tournament.players.length} players ‚Ä¢ ${tournament.bracket.length} rounds</div>
      <div class="flex-center"><button class="sm" onclick="shareTournament()">üì§ Share</button><button onclick="tournament=null;saveTourney();renderTournament()">New Tournament</button></div></div>`;
  } else {
    let cr = 0;
    for (let r = 0; r < tournament.bracket.length; r++) { if (tournament.bracket[r].some(m => !m.winner && m.p1 && m.p2)) { cr = r; break; } }
    html += `<div class="tourney-status">${getRoundName(cr, tournament.bracket.length)} in progress</div>`;
  }
  html += '<div class="bracket">';
  tournament.bracket.forEach((round, ri) => {
    html += `<div class="bracket-round"><div class="bracket-round-title">${getRoundName(ri, tournament.bracket.length)}</div>`;
    round.forEach((match, mi) => {
      const canPick = match.p1 && match.p2 && !match.winner && !champ;
      html += '<div class="bracket-match">';
      [match.p1, match.p2].forEach(p => {
        const isW = match.winner && p && p.name === match.winner;
        const isL = match.winner && p && p.name !== match.winner;
        const cls = isW ? 'winner' : isL ? 'loser' : '';
        const click = canPick && p ? `onclick="setMatchWinner(${ri},${mi},'${escapeHtml(p.name).replace(/'/g,"\\'")}')"` : '';
        html += `<div class="bracket-slot ${cls}" ${click}><span>${p ? '<span class="seed">#' + p.seed + '</span>' + escapeHtml(p.name) : '<span style="color:#333">TBD</span>'}</span>${isW ? '<span>‚úì</span>' : ''}</div>`;
      });
      html += '</div>';
    });
    html += '</div>';
  });
  html += '</div>';
  if (!champ) html += `<div class="flex-center"><button class="danger sm" onclick="if(confirm('Cancel tournament?')){tournament=null;saveTourney();renderTournament()}">Cancel</button></div>`;
  el.innerHTML = html;
}

function addTourneyInput() {
  const c = document.getElementById('tourney-inputs');
  if (c.children.length >= 16) return;
  const n = c.children.length + 1;
  const row = document.createElement('div');
  row.className = 'player-input-row';
  row.innerHTML = `<input placeholder="Player ${n}" value="Player ${n}"><button class="danger sm" onclick="removeTourneyInput(this)">‚úï</button>`;
  c.appendChild(row);
  updateTourneyBtns();
}
function removeTourneyInput(btn) { btn.parentElement.remove(); updateTourneyBtns(); }
function updateTourneyBtns() {
  const rows = document.querySelectorAll('#tourney-inputs .player-input-row');
  rows.forEach(r => r.querySelector('button').style.display = rows.length > 3 ? '' : 'none');
}
function startTournament() {
  const inputs = document.querySelectorAll('#tourney-inputs input:not([type="checkbox"])');
  let names = [...inputs].map(i => i.value.trim()).filter(Boolean);
  if (names.length < 3) return alert('Need at least 3 players');
  if (names.length > 16) return alert('Max 16 players');
  if (document.getElementById('tourney-shuffle').checked) names.sort(() => Math.random() - 0.5);
  tournament = { players: names, bracket: createBracket(names), date: new Date().toISOString() };
  saveTourney(); renderTournament();
}

renderGame();

// Register service worker for PWA / offline support
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').catch(() => {});
}
</script>
</body>
</html>
